CREATE TYPE "order_status" AS ENUM (
  'PLACED',
  'ACCEPTED',
  'DECLINED',
  'PREPARING',
  'READY',
  'DISPATCHED',
  'DELIVERED',
  'CANCELED'
);

CREATE TYPE "week_day" AS ENUM (
  'MONDAY',
  'TUESDAY',
  'WEDNESDAY',
  'THURSDAY',
  'FRIDAY',
  'SATURDAY',
  'SUNDAY'
);

CREATE TYPE "role" AS ENUM (
  'CUSTOMER',
  'OWNER',
  'MANAGER'
);

CREATE TYPE "restaurant_application_status" AS ENUM (
  'PENDING',
  'APPROVED',
  'REJECTED'
);

CREATE TYPE "user_event_type" AS ENUM (
  'LOGIN',
  'PROFILE_UPDATE'
);

CREATE TABLE "User" (
  "user_id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "email" text UNIQUE NOT NULL,
  "password_hash" text NOT NULL,
  "role" role NOT NULL,
  "surname" text NOT NULL,
  "name" text NOT NULL,
  "address" text,
  "area_code" text,
  "profile_picture" bytea,
  "geo_lat" numeric(9,6),
  "geo_lng" numeric(9,6),
  "is_active" boolean NOT NULL DEFAULT true,
  "warnings" integer NOT NULL DEFAULT 0
);

CREATE TABLE "Restaurant" (
  "restaurant_id" SERIAL PRIMARY KEY,
  "owner_id" integer,
  "restaurant_name" text NOT NULL,
  "description" text NOT NULL,
  "address" text NOT NULL,
  "area_code" text NOT NULL,
  "approved" boolean NOT NULL,
  "is_active" boolean NOT NULL,
  "application_status" restaurant_application_status NOT NULL DEFAULT 'PENDING',
  "customer_notes" text,
  "min_order_value" numeric(8,2) NOT NULL DEFAULT 0,
  "delivery_radius" numeric(5,2) NOT NULL,
  "service_fee" numeric(8,2) NOT NULL DEFAULT 0,
  "category" text,
  "geo_lat" numeric(9,6),
  "geo_lng" numeric(9,6),
  "restaurant_image" bytea
);

CREATE TABLE "OpenHours" (
  "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "restaurant_id" integer,
  "day" week_day NOT NULL,
  "open_from" time NOT NULL,
  "open_till" time NOT NULL
);

CREATE TABLE "Order" (
  "order_id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "user_id" integer,
  "restaurant_id" integer,
  "status" order_status NOT NULL,
  "created_at" timestamp NOT NULL,
  "estimated_delivery_time" timestamp,
  "total_price" numeric(8,2) NOT NULL DEFAULT 0,
  "service_fee" numeric(8,2),
  "delivery_address" text NOT NULL,
  "delivery_lat" numeric(9,6),
  "delivery_lng" numeric(9,6)
);

CREATE TABLE "Dish" (
  "dish_id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "restaurant_id" integer,
  "name" text NOT NULL,
  "description" text,
  "price" numeric(8,2) NOT NULL,
  "dish_bytea" bytea,
  "avaliable" boolean,
  "category_id" integer
);

CREATE TABLE "Categories" (
  "category_id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "restaurant_id" integer,
  "category_name" text NOT NULL
);

CREATE TABLE "Ordered_Items" (
  "order_id" integer,
  "dish_id" integer,
  "price" numeric(8,2) NOT NULL,
  "quantity" integer NOT NULL
);

CREATE TABLE "Reviews" (
  "review_id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "restaurant_id" integer,
  "user_id" integer,
  "dish_id" integer,
  "created_at" timestamp NOT NULL,
  "rating" int,
  "comment" text
);

CREATE TABLE "Voucher" (
  "voucher_id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "code" text NOT NULL,
  "voucher_value" numeric(8,2) NOT NULL,
  "voucher_value_is_percentage" boolean NOT NULL DEFAULT false,
  "valid_until" timestamp NOT NULL
);

CREATE TABLE "Used_Vouchers" (
  "order_id" integer,
  "voucher_id" integer
);

CREATE TABLE "Global_Settings" (
  "id" integer PRIMARY KEY,
  "default_service_fee" numeric(8,2) NOT NULL DEFAULT 0
);

CREATE TABLE "Delivery_Zone" (
  "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "zone_name" text NOT NULL,
  "max_radius_km" numeric(5,2)
);

CREATE TABLE "User_Event" (
  "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "user_id" integer NOT NULL,
  "event_type" user_event_type NOT NULL,
  "created_at" timestamptz NOT NULL DEFAULT now()
);

INSERT INTO "Global_Settings" (id, default_service_fee)
VALUES (1, 0)
ON CONFLICT (id) DO NOTHING;

COMMENT ON COLUMN "Reviews"."rating" IS '1-5';

ALTER TABLE "Restaurant" ADD FOREIGN KEY ("owner_id") REFERENCES "User" ("user_id");

ALTER TABLE "OpenHours" ADD FOREIGN KEY ("restaurant_id") REFERENCES "Restaurant" ("restaurant_id");

ALTER TABLE "Order" ADD FOREIGN KEY ("user_id") REFERENCES "User" ("user_id");

ALTER TABLE "Order" ADD FOREIGN KEY ("restaurant_id") REFERENCES "Restaurant" ("restaurant_id");

ALTER TABLE "Dish" ADD FOREIGN KEY ("restaurant_id") REFERENCES "Restaurant" ("restaurant_id");

ALTER TABLE "Dish" ADD FOREIGN KEY ("category_id") REFERENCES "Categories" ("category_id");

ALTER TABLE "Categories" ADD FOREIGN KEY ("restaurant_id") REFERENCES "Restaurant" ("restaurant_id");

ALTER TABLE "Ordered_Items" ADD FOREIGN KEY ("order_id") REFERENCES "Order" ("order_id");

ALTER TABLE "Ordered_Items" ADD FOREIGN KEY ("dish_id") REFERENCES "Dish" ("dish_id");

ALTER TABLE "Reviews" ADD FOREIGN KEY ("restaurant_id") REFERENCES "Restaurant" ("restaurant_id");

ALTER TABLE "Reviews" ADD FOREIGN KEY ("user_id") REFERENCES "User" ("user_id");

ALTER TABLE "Reviews" ADD FOREIGN KEY ("dish_id") REFERENCES "Dish" ("dish_id");

ALTER TABLE "Used_Vouchers" ADD FOREIGN KEY ("order_id") REFERENCES "Order" ("order_id");

ALTER TABLE "Used_Vouchers" ADD FOREIGN KEY ("voucher_id") REFERENCES "Voucher" ("voucher_id");

ALTER TABLE "User_Event" ADD FOREIGN KEY ("user_id") REFERENCES "User" ("user_id");
